<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>THE LUNATIC - Messenger</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary: #0084ff;
            --bg-chat: #ffffff;
            --bg-side: #f5f7f9;
            --text-main: #050505;
            --bubble-own: #0084ff;
            --bubble-them: #e4e6eb;
            --border: #dee2e6;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: #f0f2f5;
            margin: 0;
            display: flex;
            height: 100vh;
            justify-content: center;
            align-items: center;
        }

        /* Messenger Container */
        .messenger-app {
            display: flex;
            width: 100%;
            max-width: 1400px;
            height: 90vh;
            background: var(--bg-chat);
            box-shadow: 0 12px 28px rgba(0,0,0,0.1);
            border-radius: 8px;
            overflow: hidden;
        }

        /* Sidebar */
        .sidebar {
            width: 360px;
            background: var(--bg-side);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
        }

        .profile-card {
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            border: 1px solid var(--border);
        }

        /* Chat Window */
        .chat-window {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .chat-header {
            padding: 15px 25px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        #chat {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            list-style: none;
            background: white;
            margin: 0;
        }

        #chat li {
            max-width: 60%;
            padding: 10px 15px;
            border-radius: 18px;
            font-size: 0.95rem;
            line-height: 1.4;
            word-wrap: break-word;
        }

        /* Messenger Bubble Styles */
        #chat li.own-msg {
            align-self: flex-end;
            background: var(--bubble-own);
            color: white;
        }

        #chat li.them-msg {
            align-self: flex-start;
            background: var(--bubble-them);
            color: var(--text-main);
        }

        /* Video Call Section - Per User Request: Button styles remain logic-focused */
        .call-area {
            padding: 10px;
            background: #000;
            display: flex;
            justify-content: center;
            gap: 10px;
        }
        
        video {
            background: #242526;
            border-radius: 8px;
        }

        /* Input Area */
        .input-area {
            padding: 20px;
            border-top: 1px solid var(--border);
        }

        .input-row {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        input[type="text"] {
            flex: 1;
            padding: 12px;
            border-radius: 20px;
            border: 1px solid var(--border);
            background: #f0f2f5;
            outline: none;
        }

        .icon-btn {
            background: none;
            border: none;
            color: var(--primary);
            font-size: 1.2rem;
            cursor: pointer;
            padding: 5px;
        }

        .file-grid {
            display: flex;
            gap: 15px;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px dashed var(--border);
        }

        .file-grid input { display: none; }
        
        .file-label {
            font-size: 0.8rem;
            cursor: pointer;
            color: #65676b;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
    </style>
</head>
<body>

<div class="messenger-app">
    <div class="sidebar">
        <div class="sidebar-header">
            <h2>Chats</h2>
            <div class="profile-card">
                <small>Connected as:</small><br>
                <strong><span id="myIdDisplay">...</span></strong>
            </div>
            <div class="profile-card">
                <small>Chatting with:</small><br>
                <strong><span id="targetIdDisplay">...</span></strong>
            </div>
        </div>
        <div style="padding: 20px;">
            <p style="color: #65676b; font-size: 0.9rem;">Recent Media & Tools</p>
            <button id="recordBtn" class="icon-btn" style="font-size: 1rem; border: 1px solid; border-radius: 5px; padding: 5px 10px; width: 100%; margin-bottom: 5px;">Start Recording</button>
            <button id="sendVoiceBtn" onclick="sendVoice()" disabled class="icon-btn" style="font-size: 1rem; border: 1px solid; border-radius: 5px; padding: 5px 10px; width: 100%;">Send Voice</button>
        </div>
    </div>

    <div class="chat-window">
        <div class="chat-header">
            <div style="display:flex; align-items:center; gap:10px;">
                <div style="width:40px; height:40px; background:#ccc; border-radius:50%;"></div>
                <strong>Direct Message</strong>
            </div>
            <button onclick="startCall()" class="icon-btn" style="font-size: 1.5rem;"><i class="fas fa-video"></i></button>
        </div>

        <ul id="chat">
            </ul>

        <div class="call-area" id="callArea" style="display:none;">
            <video id="localVideo" autoplay muted playsinline width="150"></video>
            <video id="remoteVideo" autoplay playsinline width="300"></video>
        </div>

        <div class="input-area">
            <div class="input-row">
                <button class="icon-btn" onclick="takePhoto()"><i class="fas fa-camera"></i></button>
                <input id="msgInput" type="text" placeholder="Aa" onkeypress="if(event.key==='Enter') sendText()">
                <button class="icon-btn" onclick="sendText()"><i class="fas fa-paper-plane"></i></button>
            </div>
            
            <div class="file-grid">
                <label class="file-label">
                    <i class="fas fa-image fa-lg"></i> Image
                    <input id="imgInput" type="file" accept="image/*" onchange="sendFile('imgInput','image')">
                </label>
                <label class="file-label">
                    <i class="fas fa-file-video fa-lg"></i> Video
                    <input id="videoInput" type="file" accept="video/*" onchange="sendFile('videoInput','video')">
                </label>
                <label class="file-label">
                    <i class="fas fa-file-pdf fa-lg"></i> PDF
                    <input id="pdfInput" type="file" accept="application/pdf" onchange="sendFile('pdfInput','PDF')">
                </label>
                <video id="cameraPreview" width="100" autoplay style="display:none; border-radius:5px;"></video>
            </div>
        </div>
    </div>
</div>

<script>
/* ============================= */
/* CONFIGURATION (KEPT AS IS)    */
/* ============================= */
const MY_ID = "samir";
let TARGET_ID = "sishir"; 

document.getElementById("myIdDisplay").textContent = MY_ID;
document.getElementById("targetIdDisplay").textContent = TARGET_ID;

const ws = new WebSocket("ws://10.61.200.106:8080");
let mediaRecorder, audioChunks = [];
let pc, localStream;
const config = { iceServers: [{ urls: "stun:stun.l.google.com:19302" }] };

/* ============================= */
/* CONNECTION & RECEIVER         */
/* ============================= */
ws.onopen = () => ws.send(JSON.stringify({ type: "auth", user_id: MY_ID }));

ws.onmessage = async (event) => {
    if (typeof event.data === "string") {
        let msg;
        try { msg = JSON.parse(event.data); } 
        catch {
            appendMessage("them-msg", "Plain: " + event.data);
            return;
        }

        if (msg.type === "message") {
            appendMessage("them-msg", `<strong>${msg.from}:</strong> ${msg.message}`);
        }
        else if (msg.type === "offer") {
            appendMessage("them-msg", "<i>Incoming call...</i>");
            TARGET_ID = msg.from;
            document.getElementById("targetIdDisplay").textContent = TARGET_ID;
            document.getElementById("callArea").style.display = "flex";
            await createPeer();
            await pc.setRemoteDescription(msg.offer);
            const answer = await pc.createAnswer();
            await pc.setLocalDescription(answer);
            ws.send(JSON.stringify({ type: "answer", from: MY_ID, to: TARGET_ID, answer: answer }));
        }
        else if (msg.type === "answer") { await pc.setRemoteDescription(msg.answer); }
        else if (msg.type === "ice") { await pc.addIceCandidate(msg.candidate); }
    } else {
        handleBinary(event.data);
    }
};

/* ============================= */
/* UI HELPERS                    */
/* ============================= */
function appendMessage(className, htmlContent) {
    const li = document.createElement("li");
    li.className = className;
    li.innerHTML = htmlContent;
    const chat = document.getElementById("chat");
    chat.appendChild(li);
    chat.scrollTop = chat.scrollHeight;
    return li;
}

/* ============================= */
/* SENDING LOGIC (KEPT AS IS)    */
/* ============================= */
function sendText(){
    const input = document.getElementById("msgInput");
    const val = input.value.trim();
    if(!val) return;
    appendMessage("own-msg", val);
    ws.send(JSON.stringify({ type:"send", from: MY_ID, to: TARGET_ID, message: val }));
    input.value="";
}

function sendFile(id, label){
    const fileInput = document.getElementById(id);
    const file = fileInput.files[0];
    if(!file) return;

    const reader = new FileReader();
    reader.onload = () => {
        ws.send(JSON.stringify({ type:"binary", to: TARGET_ID }));
        ws.send(reader.result);
    };
    reader.onloadend = () => {
        const li = appendMessage("own-msg", `Sent ${label}: `);
        const url = URL.createObjectURL(file);
        if(file.type.startsWith("image")){
            const img=document.createElement("img"); img.src=url; img.style.maxWidth="100%"; li.appendChild(img);
        } else if(file.type.startsWith("video")){
            const v=document.createElement("video"); v.src=url; v.controls=true; v.style.maxWidth="100%"; li.appendChild(v);
        } else {
            const a=document.createElement("a"); a.href=url; a.target="_blank"; a.textContent="File"; a.style.color="white"; li.appendChild(a);
        }
    };
    reader.readAsArrayBuffer(file);
    fileInput.value="";
}

/* ============================= */
/* BINARY HANDLER (KEPT AS IS)   */
/* ============================= */
async function handleBinary(data) {
    const arrayBuffer = await data.arrayBuffer();
    const uint8 = new Uint8Array(arrayBuffer);
    let mimeType = "application/octet-stream";
    
    // Simple magic byte detection
    if (uint8[0] === 0x25 && uint8[1] === 0x50) mimeType = "application/pdf";
    else if (uint8[0] === 0x89) mimeType = "image/png";
    else if (uint8[0] === 0xFF) mimeType = "image/jpeg";
    else if (uint8[0] === 0x1A) mimeType = "video/webm";

    const blob = new Blob([arrayBuffer], { type: mimeType });
    const url = URL.createObjectURL(blob);
    const li = appendMessage("them-msg", "Received: ");

    if (mimeType.startsWith("image")) {
        const img = document.createElement("img"); img.src = url; img.style.maxWidth = "100%"; li.appendChild(img);
    } else if (mimeType.startsWith("video")) {
        const v = document.createElement("video"); v.src = url; v.controls = true; v.style.maxWidth = "100%"; li.appendChild(v);
    } else if (mimeType.startsWith("audio")) {
        const a = document.createElement("audio"); a.src = url; a.controls = true; li.appendChild(a);
    } else {
        const a = document.createElement("a"); a.href = url; a.textContent = "Open File"; li.appendChild(a);
    }
}

/* ============================= */
/* VOICE / CAMERA / WEBRTC       */
/* ============================= */
const recordBtn=document.getElementById("recordBtn");
recordBtn.onclick=async()=>{
    if(recordBtn.textContent==="Start Recording"){
        audioChunks=[];
        const stream=await navigator.mediaDevices.getUserMedia({audio:true});
        mediaRecorder=new MediaRecorder(stream);
        mediaRecorder.ondataavailable=e=>audioChunks.push(e.data);
        mediaRecorder.start();
        recordBtn.textContent="Stop Recording";
        recordBtn.style.color="red";
    } else {
        mediaRecorder.stop();
        mediaRecorder.onstop=()=>{
            recordBtn.textContent="Start Recording";
            recordBtn.style.color="";
            document.getElementById("sendVoiceBtn").disabled=false;
        };
    }
};

function sendVoice(){
    const blob = new Blob(audioChunks, { type: "audio/webm" });
    const url = URL.createObjectURL(blob);
    const li = appendMessage("own-msg", "");
    const audio = document.createElement("audio"); audio.src = url; audio.controls = true;
    li.appendChild(audio);

    const reader = new FileReader();
    reader.onload = () => {
        ws.send(JSON.stringify({ type: "binary", from: MY_ID, to: TARGET_ID }));
        ws.send(reader.result);
    };
    reader.readAsArrayBuffer(blob);
    document.getElementById("sendVoiceBtn").disabled = true;
}

async function takePhoto(){
    const video=document.getElementById("cameraPreview");
    video.style.display="block";
    const stream=await navigator.mediaDevices.getUserMedia({video:true});
    video.srcObject=stream;
    await video.play();
    const canvas=document.createElement("canvas");
    canvas.width=video.videoWidth; canvas.height=video.videoHeight;
    canvas.getContext("2d").drawImage(video,0,0);
    const blob=await new Promise(r=>canvas.toBlob(r,"image/png"));
    ws.send(JSON.stringify({ type:"binary", from: MY_ID, to: TARGET_ID }));
    ws.send(await blob.arrayBuffer());
    stream.getTracks().forEach(t=>t.stop());
    video.style.display="none";
    appendMessage("own-msg", "Sent a photo.");
}

async function createPeer(){
    pc=new RTCPeerConnection(config);
    pc.onicecandidate=e=>{
        if(e.candidate) ws.send(JSON.stringify({ type:"ice", from: MY_ID, to: TARGET_ID, candidate:e.candidate }));
    };
    pc.ontrack=e=>{ document.getElementById("remoteVideo").srcObject=e.streams[0]; };
    if(localStream) localStream.getTracks().forEach(track=>pc.addTrack(track,localStream));
}

async function startCall(){
    document.getElementById("callArea").style.display = "flex";
    localStream=await navigator.mediaDevices.getUserMedia({video:true,audio:true});
    document.getElementById("localVideo").srcObject=localStream;
    await createPeer();
    const offer=await pc.createOffer();
    await pc.setLocalDescription(offer);
    ws.send(JSON.stringify({ type:"offer", from: MY_ID, to: TARGET_ID, offer:offer }));
}
</script>
</body>
</html>