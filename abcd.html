<!DOCTYPE html>
<html>
<head>
<title>Complete Chat + WebRTC</title>
</head>
<body>

<h2>Chat + Call</h2>

<p>Your ID: <span id="myId"></span></p>
<p>Chatting with: <span id="targetId"></span></p>

<input id="msg" placeholder="Message">
<button onclick="sendText()">Send</button>
<br><br>

<input type="file" id="fileInput">
<button onclick="sendFile()">Send File</button>
<br><br>

<button onclick="startCall()">Start Call</button>
<br><br>

<video id="localVideo" autoplay muted width="200"></video>
<video id="remoteVideo" autoplay width="200"></video>

<ul id="chat"></ul>

<script>
const MY_ID = "user1";
const TARGET_ID = "user2";

document.getElementById("myId").textContent = MY_ID;
document.getElementById("targetId").textContent = TARGET_ID;

const ws = new WebSocket("ws://YOUR_SERVER_IP:8080");

let pc;
let localStream;
let incomingFileType = null;

const config = {
  iceServers: [{ urls: "stun:stun.l.google.com:19302" }]
};

/* ================= CONNECT ================= */
ws.onopen = () => {
  ws.send(JSON.stringify({
    type: "auth",
    user_id: MY_ID
  }));
};

/* ================= MESSAGE HANDLER ================= */
ws.addEventListener("message", async event => {

  // TEXT
  if (typeof event.data === "string") {
    const msg = JSON.parse(event.data);

    if (msg.type === "message") {
      addChat("From " + msg.from + ": " + msg.message);
    }

    if (msg.type === "file-info") {
      incomingFileType = msg.fileType;
    }

    if (msg.type === "offer") {
      await createPeer();
      await pc.setRemoteDescription(msg.offer);
      const answer = await pc.createAnswer();
      await pc.setLocalDescription(answer);

      ws.send(JSON.stringify({
        type: "answer",
        from: MY_ID,
        to: msg.from,
        answer: answer
      }));
    }

    if (msg.type === "answer") {
      await pc.setRemoteDescription(msg.answer);
    }

    if (msg.type === "ice") {
      await pc.addIceCandidate(msg.candidate);
    }
  }

  // BINARY
  else {
    const buffer = await event.data.arrayBuffer();
    const blob = new Blob([buffer], { type: incomingFileType });
    const url = URL.createObjectURL(blob);

    const li = document.createElement("li");

    if (incomingFileType.startsWith("image")) {
      const img = document.createElement("img");
      img.src = url;
      img.width = 200;
      li.appendChild(img);
    }
    else if (incomingFileType.startsWith("video")) {
      const video = document.createElement("video");
      video.src = url;
      video.controls = true;
      video.width = 250;
      li.appendChild(video);
    }
    else if (incomingFileType.startsWith("audio")) {
      const audio = document.createElement("audio");
      audio.src = url;
      audio.controls = true;
      li.appendChild(audio);
    }
    else if (incomingFileType === "application/pdf") {
      const a = document.createElement("a");
      a.href = url;
      a.target = "_blank";
      a.textContent = "Open PDF";
      li.appendChild(a);
    }

    document.getElementById("chat").appendChild(li);
  }
});

/* ================= TEXT ================= */
function sendText(){
  const input = document.getElementById("msg");
  if(!input.value) return;

  ws.send(JSON.stringify({
    type:"send",
    to: TARGET_ID,
    message: input.value
  }));

  addChat("You: " + input.value);
  input.value="";
}

/* ================= FILE ================= */
function sendFile(){
  const file = document.getElementById("fileInput").files[0];
  if(!file) return;

  const reader = new FileReader();

  reader.onload = () => {
    ws.send(JSON.stringify({
      type:"binary",
      to: TARGET_ID,
      fileType: file.type
    }));
    ws.send(reader.result);
  };

  reader.readAsArrayBuffer(file);
}

/* ================= WEBRTC ================= */
async function createPeer(){
  pc = new RTCPeerConnection(config);

  pc.onicecandidate = e => {
    if(e.candidate){
      ws.send(JSON.stringify({
        type:"ice",
        from: MY_ID,
        to: TARGET_ID,
        candidate: e.candidate
      }));
    }
  };

  pc.ontrack = e => {
    document.getElementById("remoteVideo").srcObject = e.streams[0];
  };

  if(!localStream){
    localStream = await navigator.mediaDevices.getUserMedia({video:true,audio:true});
    document.getElementById("localVideo").srcObject = localStream;
  }

  localStream.getTracks().forEach(track =>
    pc.addTrack(track, localStream)
  );
}

async function startCall(){
  await createPeer();

  const offer = await pc.createOffer();
  await pc.setLocalDescription(offer);

  ws.send(JSON.stringify({
    type:"offer",
    from: MY_ID,
    to: TARGET_ID,
    offer: offer
  }));
}

/* ================= HELPER ================= */
function addChat(text){
  const li = document.createElement("li");
  li.textContent = text;
  document.getElementById("chat").appendChild(li);
}
</script>

</body>
</html>